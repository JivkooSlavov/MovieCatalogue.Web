@using MovieCatalogue.Web.ViewModels.Movie;
@model MovieInfoViewModel;

@{
    ViewData["Title"] = "Movie Details";
}

<div class="container">
    <h1>@Model.Title</h1>
    <div class="row">
        <div class="col-md-4">
            <img src="@Model.PosterUrl" alt="@Model.Title Poster" class="img-fluid" />
        </div>
        <div class="col-md-8">
            <p><strong>Description:</strong> @Model.Description</p>
            <p><strong>Director:</strong> @Model.Director</p>
            <p><strong>Cast:</strong> @Model.Cast</p>
            <p><strong>Genre:</strong> @Model.Genre</p>
            <p><strong>Release Date:</strong> @Model.ReleaseDate.ToString()</p>
            <p><strong>Average Rating:</strong> @Model.Rating.ToString("F2") / 5.00</p>
            <hr />

            <h3>Watch Trailer</h3>
            <a href="@Model.TrailerUrl" target="_blank" class="btn btn-danger">
                <i class="fab fa-youtube"></i> Watch on YouTube
            </a>
            <h3>
                <td>
                    @if (User?.Identity?.IsAuthenticated ?? false)
                    {
                        @if (Model.IsFavorite)
                        {
                            <form asp-action="RemoveFromFavorites" asp-controller="Favorite" method="post">
                                <input type="hidden" name="movieId" value="@Model.Id" />
                                <button type="submit" class="btn btn-warning mt-2">Remove from Favorites</button>
                            </form>
                        }
                        else
                        {
                            <form asp-action="AddToFavorites" asp-controller="Favorite" method="post">
                                <input type="hidden" name="movieId" value="@Model.Id" />
                                <button type="submit" class="btn btn-primary mt-2">Add to Favorites</button>
                            </form>
                        }
                    }
                </td>
            </h3>
        </div>
    </div>
    <h3>Rate this Movie</h3>
    <form asp-action="Create" asp-controller="Rating" method="post">
        <input type="hidden" name="movieId" value="@Model.Id" />
        <select name="value" class="form-control" required>
            <option value="">Select a Rating</option>
            <option value="1">1 - Poor</option>
            <option value="2">2 - Fair</option>
            <option value="3">3 - Good</option>
            <option value="4">4 - Very Good</option>
            <option value="5">5 - Excellent</option>
        </select>
        <button type="submit" class="btn btn-primary mt-2">Submit Rating</button>
    </form>

    @if (Model.Rating > 0)
    {
        <p>Average Rating: @Model.Rating/5</p>
    }
    else
    {
        <p>This movie has not been rated yet.</p>
    }

    <h3>Reviews</h3>
    @if (Model.Reviews.Any())
    {
        <ul class="list-group">
            @foreach (var review in Model.Reviews)
            {
                <li class="list-group-item">
                    <strong>@review.UserName:</strong>
                    <p>@review.Content</p>
                    <small>@review.CreatedAt.ToString("f")</small>

                    @if (User.Identity.IsAuthenticated && User.Identity.Name == review.UserName)
                    {
                        <div class="mt-2">
                            <a asp-action="Edit" asp-controller="Review" asp-route-id="@review.Id" class="btn btn-sm btn-primary">Edit</a>
                            <a asp-action="Delete" asp-controller="Review" asp-route-id="@review.Id" method="post" style="display: inline-block;">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </a>
                        </div>

                    }
                </li>
            }
        </ul>
    }
    else
    {
        <p>No reviews yet. Be the first to review this movie!</p>
    }
    @if (User.Identity.IsAuthenticated)
    {
        <hr />
        <h4>Write a Review</h4>
        <form asp-action="Create" asp-controller="Review" method="post">
            <input type="hidden" name="movieId" value="@Model.Id" />
            <textarea name="content" class="form-control" rows="3" placeholder="Write your review here..." required></textarea>
            <button type="submit" class="btn btn-primary mt-2">Submit Review</button>
        </form>
    }
    else
    {
        <p class="text-danger">You need to <a asp-area="Identity" asp-page="/Account/Login">log in</a> to write a review.</p>
    }
</div>
